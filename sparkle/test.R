# LICENSE SPARKLE TECH

#' @export
count_events=\(pool,app_id,n=1L){cur=as.Date(current_date())-n+1L;prev=as.Date(current_date())-n*2L+1L;case_cur=sprintf("SUM(CASE WHEN event_time >= '%s' THEN 1 ELSE 0 END) AS cur_events",cur);case_prev=sprintf("SUM(CASE WHEN event_time >= '%s' AND event_time < '%s' THEN 1 ELSE 0 END) AS prev_events",prev,cur);case=paste(case_cur,", ",case_prev);query=paste("SELECT",case,"FROM events WHERE app_id = ?")|>parameterize_query();params=list(app_id);conn=checkout_conn(pool=pool);on.exit(poolReturn(conn));res=dbSendQuery(conn=conn,statement=query);dbBind(res,params=params);found=dbFetch(res);dbClearResult(res);found=lapply(found,as.integer);pct_change=paste0(round((found$cur_events-found$prev_events)/found$prev_events*100,digits=1L),"%");if(identical(found$prev_events,0L)){pct_change="-";};status=;"increase";;"decrease";found$pct_change=pct_change;found$status=status;found;};